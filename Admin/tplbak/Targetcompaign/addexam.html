<script src="__PUBLIC__/ace/assets/js/jquery-1.10.2.min.js"></script>
<div class="breadcrumbs" id="breadcrumbs">
  <script type="text/javascript">
    try {
      ace.settings.check('breadcrumbs', 'fixed')
    } catch (e) {
    }
  </script>
<style>

.page-header1 h1 span{background-color:red;width:120px;float:left;postion:absolute;}
.wordChecked{
	background: #D4EFFF;
}
#selectedList em{
	font-style: normal;
	cursor: pointer;
	margin-left: 9px;
}
#selectedList em:hover{
	background: #D4EFFF;
}
.lilist{
	line-height:25px;
}
</style>
  <!-- <ul class="breadcrumb">
    <li>
      <i class="icon-home home-icon"></i>
      <a href="#">靶场比赛管理</a>
    </li>
    <li class="active">添加</li>
  </ul> --><!-- .breadcrumb -->
</div>
<!-- 弹出层 -->
<div id="keyworddiv" class="areadiv" style="display:none;border:1px solid #ccc;height:410px;width:700px;margin-left:5%;z-index:1002;position:absolute;background:#fff;">
<div style="height:380px;width:700px;overflow-y:auto;background:#fff;">
学校名称：
			<select name="schoollist" id="schoollist">
				<option value=''>--请选择--</option>
				<option value="1">靶场题</option>
				<option value="3">单选题</option>
				<option value="4">多选题</option>
			</select>
<foreach name="examlist" item="cval" key="ck">
<table style="width:100%;"  name="classes" id="class{$ck}">
	<foreach name="cval" item="info" >
	<tr style="border-bottom:1px dotted #ccc;">	
		<td>
			<input type="checkbox" name="categoryid" value="{$ck}{$info.id}" />
			<div style="width:20%;float:left;font-size:14px;margin-top:10px;">
				{$info.question}
			</div>
		</td>
	</tr>
	</foreach>
</table>
</foreach>
</div>
<div style="text-align:center;margin-top:5px;">
	<input type="button" value="保存" class="tijiao" onclick="winsub()" >
	<input type="button" value="关闭" class="tijiao" onclick="winclose()" >
	<input type="button" id="qSelectAll" value="全选" onclick="qselect()" />
	<input type="button" id="qSelectOthers" value="反选" onclick="qselectothers()"/>
</div>
</div>
<!-- 弹出层 end-->
<div class="page-content">

  <div class="page-header">
    <h1>
    <span data-id="1">
       1, 基本信息
    </span>
    <span data-id="2">
        <i class="icon-double-angle-right"></i>2, 选择人员
    </span>
    <span data-id="3">
        <i class="icon-double-angle-right"></i>3, 选择试题
      </span>
      <span data-id="4">
        <i class="icon-double-angle-right"></i>4, 发布
      </span>
    </h1>
  </div><!-- /.page-header -->
  <br/>
  <div class="row">
    <div class="col-xs-12">
      <!-- PAGE CONTENT BEGINS -->
      <form class="form-horizontal" role="form" action="../Targetcompaign/edit" method="post" onsubmit="return sub();">
     
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" for="form-field-1">选择试题: </label>
          <div class="col-sm-9" id="showarea">
          		<input type="text" name="keywordInput" id="keywordInput" />
          		<button class="btn btn-info" type="button" onclick="choose();" style="height:30px;">
	              选择试题
	           </button>
          </div>
          	<div id="searchdiv" style="border:1 solid black;height:200px;width:200px;display:none;overflow-y:auto;background-color:#fafafa;position:absolute;margin-left:26%;margin-top:29px;z-index:1002;">
				<ul id="wordsList" style="list-style-type:none;padding-left:0px;cursor:pointer;">
				</ul>
				<p class="btns" style="margin-left: 10px;">
					<input type="button" class="ok" value="确定">
					<input type="button" class="cancel" value="取消">
				</p>
			</div> 
			<table id="selectedList" style="max-height:500px;width:70%;overflow-y:auto;margin-left:16%;" border="1px">
				<foreach name="qlist" item="qinfo">
					<tr style="text-align:center;">
					<td class="qtitle" >{$qinfo.question}</td>
					<td style="width:100px" class="operate">
						<if condition="$qinfo['type'] eq '1'">
						<a target="_bank" href="{:U('TargetExamination/add',array('id'=>$qinfo['id']))}">预览</a>
						<elseif condition="$qinfo['type'] eq '3'"/>
						<a target="_bank" href="{:U('SingleExamination/add',array('id'=>$qinfo['id']))}">预览</a>
						<elseif condition="$qinfo['type'] eq '4'"/>
						<a target="_bank" href="{:U('MultipleExamination/add',array('id'=>$qinfo['id']))}">预览</a>
						</if>
						&nbsp;&nbsp;<a href="javascript:void(0);" class="rmid" >删除</span></td>
					<input type="hidden" name="kyids" value="{$qinfo.type}{$qinfo.id}" />
					</tr>
				</foreach>
			</table>       
        </div>
        <input type="hidden" id="qids" name="qids" value="" />
        
        <input type="hidden" id="id"  name="id" value="{$id}"/>
        <input type="hidden" id="type" name="type" value="{$type}"/>
        <input type="hidden" id="step" name="step" value="{$step}"/>
        <div class="clearfix form-actions">
          <div class="col-md-offset-3 col-md-9">
            <button class="btn btn-info" type="submit">
              <i class="icon-ok bigger-110"></i> 下一步
            </button>
          </div>
        </div>
        
      </form>
      <!-- PAGE CONTENT ENDS -->
    </div><!-- /.col -->
  </div>
</div><!-- /.page-content -->


<script type="text/javascript">
function choose(){
	$("table[name='classes']").hide();
	$("#keyworddiv").find("input[type='checkbox']").prop("checked",false);
	showmark();
	var div = $("#keyworddiv");
	div.show();
	//$(document.body).append(div);
}

var selectedItem=$('<tr style="text-align:center;"><td class="qtitle">{$qinfo.question}</td><td style="width:100px" class="operate"><a href="">预览</a>&nbsp;&nbsp;<a href="javascript:void(0);" class="rmid" >删除</a></td><input type="hidden" name="kyids" value="" /></tr>');
// 弹窗
function winsub(){
	var tabid = $("#schoollist").val();
	
	var temps =[];
	$('#keyworddiv').find("input[name='categoryid']:checked").each(function(){
		var ktxt = $(this).parent().find('div').text();
		var kid = $(this).val(),
			k_cloneitem = selectedItem.clone();
		if(tabid == 1){
			var url = "{:U('TargetExamination/add')}";
		}else if(tabid == 3){
			var url = "{:U('SingleExamination/add')}";
		}else if(tabid == 4){
			var url = "{:U('MultipleExamination/add')}";
		}
		url = url+"?id="+kid.substring(1);
		var markEle=$("#selectedList").find("input[value='"+kid+"']");
		if(markEle.length===0){
			k_cloneitem.find("td").first().text(ktxt).parent().find("input").attr("value",kid).parent().find("a").first().attr("href",url);
			temps.push(k_cloneitem);
		}
	});		
	$("#selectedList").append(temps);
	winclose();
}
//显示遮罩层
function showmark() {
        var bw = $(window).width();
        var bh = $(window).height();
        var e = $('<div></div>');
        e.css('background', '#000');
        e.css('width', bw + 'px');
        e.css('height', bh + 'px');
        e.css('position', 'absolute');
        e.css('left', '0');
        e.css('top', '0');
        e.css('-khtml-opacity', '0.5');
        e.css('-moz-opacity', '0.5');
        e.css('opacity', '0.5');
        e.css('filter', 'alpha(opacity=50)');
        e.css('zIndex', '1001');
        e.attr('id', 'masker');
        $(document.body).append(e);
}
    //关闭遮罩层
function winclose() {
		$("#keyworddiv").hide();
        $('#masker').remove();
}
//地域全选
function qselect(){
	var tabid = $("#schoollist").val();
	$("#class"+tabid).find("input[name='categoryid']").prop("checked",true);
}
//地域反选
function qselectothers(){
	var tabid = $("#schoollist").val();
	$("#class"+tabid).find("input[name='categoryid']").each(function(idx,ele){
		$(this).prop('checked')?$(this).prop('checked',false):$(this).prop('checked',true);
	});
}
//关键词下拉
/*
var wordItem=$("<li><input type='checkbox' class='checkWord'/><span data-id='' class='wordText'></span></li>");
$("#keywordInput").keyup(function(){
	var currVal=$.trim($(this).val()),
		postUrl="{:U('Targetcompaign/membersearch')}";
		$("#wordsList").empty();
		if(currVal){
			$.post(postUrl,{keyword:currVal},function(data){
			if(data.status == 1){
					var wordList=$("#wordsList").empty(),
						result=data.data,
						items=[];
					$.each(result,function(key,value){
						var clonedItem=wordItem.clone();
						clonedItem.find(".wordText").text(value.user_name).attr("data-id",key);
						items.push(clonedItem);
					});
					wordList.append(items);
					$("#wordsList").parent().show();
			}
			});
	}

});

$("#wordsList").on("click","li",function(){
	var currEle=$(this),
		cb=currEle.find(".checkWord");
	if(currEle.hasClass("wordChecked")){
		currEle.removeClass("wordChecked");
		cb.prop("checked",false);
	}else{
		currEle.addClass("wordChecked");
		cb.prop("checked",true);
	}
});
//确定
$("#searchdiv .btns .ok").click(function(){
	var selected=$("#wordsList").find("li.wordChecked"),
		temps=[];
	$.each(selected, function() {    
		var id= $(this).find(".wordText").attr("data-id"),
			txt=$(this).find(".wordText").text(),
			clonedItem=selectedItem.clone();
		var markEle=$("#selectedList").find("input[value='"+id+"']");
		if(markEle.length===0){
			clonedItem.find("span").text(txt)
					.end().find("input").attr("value",id);
			temps.push(clonedItem);
		}
	});
	$("#selectedList").append(temps);
	$("#wordsList").parent().hide();
});
//取消
$("#searchdiv .btns .cancel").click(function(){
	$("#wordsList").parent().hide();
});
*/

$("#schoollist").on("change",function(){
	$("table[name='classes']").hide();
	var scid = $(this).val();
	$("#class"+scid).show();
});
$("#selectedList").on("click","a",function(){
	if($(this).attr("class") == "rmid"){
		$(this).parent().parent().remove();
	}
});

function sub(){
	var qids = '';
	$("input[name='kyids']").each(function(m,obj){
		qids +=$(this).val()+"|"+$.trim($(this).parent().find("td.qtitle").text())+"@@";
	});
	$("#qids").val(qids);
	if(qids == ""){
		alert("您还没选择试题");
		return false;
	}
}
</script>
