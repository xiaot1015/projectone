<script src="__PUBLIC__/ace/assets/js/jquery-1.10.2.min.js"></script>
<!-- 弹出层 -->
<div id="keyworddiv" class="areadiv" style="display:none;border:1px solid #ccc;height:410px;width:700px;margin-left:15%;z-index:1002;position:absolute;background:#fff;">
<div style="height:380px;width:700px;overflow-y:auto;background:#fff;">
学校名称：
		<select name="schoollist" id="schoollist">
			<option value=''>--请选择--</option>
			<option value="1">靶场题</option>
			<option value="3">单选题</option>
			<option value="4">多选题</option>
		</select>
<foreach name="examlist" item="cval" key="ck">
<table style="width:100%;"  name="classes" id="class{$ck}">
	<foreach name="cval" item="info" >
	<tr style="border-bottom:1px dotted #ccc;">	
		<td>
			<input type="checkbox" name="categoryid" value="{$ck}{$info.id}" />
			<div style="width:20%;float:left;font-size:14px;margin-top:10px;">
				{$info.question}
			</div>
		</td>
	</tr>
	</foreach>
</table>
</foreach>
</div>
<div style="text-align:center;margin-top:5px;">
	<input type="button" value="保存" class="tijiao" onclick="winsub()" >
	<input type="button" value="关闭" class="tijiao" onclick="winclose()" >
	<input type="button" id="qSelectAll" value="全选" onclick="qselect()" />
	<input type="button" id="qSelectOthers" value="反选" onclick="qselectothers()"/>
</div>
</div>
<!-- 弹出层 end-->
<div id="right">
	<div id="course">
		<div id="tit">比赛流程引导：</div>
		<ul id="course_ul">
			<li class="li20">基本信息</li>
			<li class="li20">选择人员</li>
			<li class="li11">选择试题</li>
			<li class="li40">应用发布</li>
		</ul>
	</div>
	<form name="form" action="../Targetcompaign/edit" method="post" onsubmit="return sub();">
		<div id="notice1" style="top:80px;">
			<div class="tijiawanigahnegg" style="margin-left:20px;margin-top:20px;">
			
			
      			<a href="javascript:choose()">选择试题</a>选择试题:
			<input style="width:250px;" type="text" name="keywordInput" id="keywordInput" />
      		
			</div>
		
		   <div id="searchdiv" style="border:1 solid black;height:200px;width:200px;display:none;overflow-y:auto;background-color:#fafafa;position:absolute;margin-left:26%;margin-top:29px;z-index:1002;">
				<ul id="wordsList" style="list-style-type:none;padding-top:10px;padding-left:0px;cursor:pointer;color: #fdfefe;font-weight: 600;font-size: 14px;">
				</ul>
				<p class="btns" style="margin-left: 10px;">
					<input type="button" class="ok" value="确定">
					<input type="button" class="cancel" value="取消">
				</p>
			</div> 
			<div id="searchdiv" style="border:1 solid black;height:200px;width:200px;display:none;overflow-y:auto;background-color:#fafafa;position:absolute;margin-left:26%;margin-top:29px;z-index:1002;">
				<ul id="wordsList" style="list-style-type:none;padding-left:0px;cursor:pointer;">
				</ul>
				<p class="btns" style="margin-left: 10px;">
					<input type="button" class="ok" value="确定">
					<input type="button" class="cancel" value="取消">
				</p>
			</div> 
			<table id="selectedList" style="max-height:500px;width:80%;overflow-y:auto;margin-left:9%;" border="1px">
				<foreach name="qlist" item="qinfo">
					<tr style="text-align:center;">
					<td class="qtitle" >{$qinfo.question}</td>
					<td style="width:100px" class="operate">
						<if condition="$qinfo['type'] eq '1'">
						<a target="_bank" href="{:U('TargetExamination/add',array('id'=>$qinfo['id']))}">预览</a>
						<elseif condition="$qinfo['type'] eq '3'"/>
						<a target="_bank" href="{:U('SingleExamination/add',array('id'=>$qinfo['id']))}">预览</a>
						<elseif condition="$qinfo['type'] eq '4'"/>
						<a target="_bank" href="{:U('MultipleExamination/add',array('id'=>$qinfo['id']))}">预览</a>
						</if>
						&nbsp;&nbsp;<a href="javascript:void(0);" class="rmid" >删除</span></td>
					<input type="hidden" name="kyids" value="{$qinfo.type}{$qinfo.id}" />
					</tr>
				</foreach>
			</table>  
		</div>
		<input type="hidden" id="qids" name="qids" value="" />
        
        <input type="hidden" id="id"  name="id" value="{$id}"/>
        <input type="hidden" id="type" name="type" value="{$type}"/>
        <input type="hidden" id="step" name="step" value="{$step}"/>
		<button  type="submit" class="btn" >下一步</button>
	</form>
</div>

<script type="text/javascript">
function choose(){
	$("table[name='classes']").hide();
	$("#keyworddiv").find("input[type='checkbox']").prop("checked",false);
	showmark();
	var div = $("#keyworddiv");
	div.show();
	//$(document.body).append(div);
}

var selectedItem=$('<tr style="text-align:center;"><td class="qtitle">{$qinfo.question}</td><td style="width:100px" class="operate"><a href="">预览</a>&nbsp;&nbsp;<a href="javascript:void(0);" class="rmid" >删除</a></td><input type="hidden" name="kyids" value="" /></tr>');
// 弹窗
function winsub(){
	var tabid = $("#schoollist").val();
	
	var temps =[];
	$('#keyworddiv').find("input[name='categoryid']:checked").each(function(){
		var ktxt = $(this).parent().find('div').text();
		var kid = $(this).val(),
			k_cloneitem = selectedItem.clone();
		if(tabid == 1){
			var url = "{:U('TargetExamination/add')}";
		}else if(tabid == 3){
			var url = "{:U('SingleExamination/add')}";
		}else if(tabid == 4){
			var url = "{:U('MultipleExamination/add')}";
		}
		url = url+"?id="+kid.substring(1);
		var markEle=$("#selectedList").find("input[value='"+kid+"']");
		if(markEle.length===0){
			k_cloneitem.find("td").first().text(ktxt).parent().find("input").attr("value",kid).parent().find("a").first().attr("href",url);
			temps.push(k_cloneitem);
		}
	});		
	$("#selectedList").append(temps);
	winclose();
}
//显示遮罩层
function showmark() {
        var bw = $(window).width();
        var bh = $(window).height();
        var e = $('<div></div>');
        e.css('background', '#000');
        e.css('width', bw + 'px');
        e.css('height', bh + 'px');
        e.css('position', 'absolute');
        e.css('left', '0');
        e.css('top', '0');
        e.css('-khtml-opacity', '0.5');
        e.css('-moz-opacity', '0.5');
        e.css('opacity', '0.5');
        e.css('filter', 'alpha(opacity=50)');
        e.css('zIndex', '1001');
        e.attr('id', 'masker');
        $(document.body).append(e);
}
    //关闭遮罩层
function winclose() {
		$("#keyworddiv").hide();
        $('#masker').remove();
}
//地域全选
function qselect(){
	var tabid = $("#schoollist").val();
	$("#class"+tabid).find("input[name='categoryid']").prop("checked",true);
}
//地域反选
function qselectothers(){
	var tabid = $("#schoollist").val();
	$("#class"+tabid).find("input[name='categoryid']").each(function(idx,ele){
		$(this).prop('checked')?$(this).prop('checked',false):$(this).prop('checked',true);
	});
}
//关键词下拉
/*
var wordItem=$("<li><input type='checkbox' class='checkWord'/><span data-id='' class='wordText'></span></li>");
$("#keywordInput").keyup(function(){
	var currVal=$.trim($(this).val()),
		postUrl="{:U('Targetcompaign/membersearch')}";
		$("#wordsList").empty();
		if(currVal){
			$.post(postUrl,{keyword:currVal},function(data){
			if(data.status == 1){
					var wordList=$("#wordsList").empty(),
						result=data.data,
						items=[];
					$.each(result,function(key,value){
						var clonedItem=wordItem.clone();
						clonedItem.find(".wordText").text(value.user_name).attr("data-id",key);
						items.push(clonedItem);
					});
					wordList.append(items);
					$("#wordsList").parent().show();
			}
			});
	}

});

$("#wordsList").on("click","li",function(){
	var currEle=$(this),
		cb=currEle.find(".checkWord");
	if(currEle.hasClass("wordChecked")){
		currEle.removeClass("wordChecked");
		cb.prop("checked",false);
	}else{
		currEle.addClass("wordChecked");
		cb.prop("checked",true);
	}
});
//确定
$("#searchdiv .btns .ok").click(function(){
	var selected=$("#wordsList").find("li.wordChecked"),
		temps=[];
	$.each(selected, function() {    
		var id= $(this).find(".wordText").attr("data-id"),
			txt=$(this).find(".wordText").text(),
			clonedItem=selectedItem.clone();
		var markEle=$("#selectedList").find("input[value='"+id+"']");
		if(markEle.length===0){
			clonedItem.find("span").text(txt)
					.end().find("input").attr("value",id);
			temps.push(clonedItem);
		}
	});
	$("#selectedList").append(temps);
	$("#wordsList").parent().hide();
});
//取消
$("#searchdiv .btns .cancel").click(function(){
	$("#wordsList").parent().hide();
});
*/

$("#schoollist").on("change",function(){
	$("table[name='classes']").hide();
	var scid = $(this).val();
	$("#class"+scid).show();
});
$("#selectedList").on("click","a",function(){
	if($(this).attr("class") == "rmid"){
		$(this).parent().parent().remove();
	}
});

function sub(){
	var qids = '';
	$("input[name='kyids']").each(function(m,obj){
		qids +=$(this).val()+"|"+$.trim($(this).parent().find("td.qtitle").text())+"@@";
	});
	$("#qids").val(qids);
	if(qids == ""){
		alert("您还没选择试题");
		return false;
	}
}
</script>
