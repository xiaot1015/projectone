<script src="__PUBLIC__/ace/assets/js/jquery-2.0.3.min.js"></script>
<style type="text/css">
.line{margin-top:15px; }
.line label{color:#fff;font-size:14px;margin: 20px;}
.line select{width:100px;}
</style>
<div id="right">
    <div id="course">
        <div id="tit">比赛流程引导：</div>
        <ul id="course_ul">
            <li class="li10">基本信息</li>
            <li class="li21">选择人员发布</li>
            <!-- <li class="li40">应用发布</li> -->
        </ul>
    </div>
<foreach name="list" item="v">
    <div class="line">
        <label class="col-sm-1  control-label no-padding-right" for="form-field-1"> 对抗靶场 </label>
        <select disabled>
            <option value=''>请选择</option>
            <?php foreach($competition as $val):?>
            <option value="<?php echo $val['resistcomp_id'];?>" <?php if($v['targetvm_id']==$val['resistcomp_id']): ?>selected<?php endif;?> ><?php echo $val['question']?></option>
            <?php endforeach;?>
        </select>
        <label class="col-sm-1  control-label no-padding-right" for="form-field-1"> 团队 </label>
        <select disabled>
            <option value=''>请选择</option>

            <?php foreach($list_team_array as $key=>$val):?>
            <option value="<?php echo $key;?>" <?php if($v['team_id']==$key): ?>selected<?php endif;?> ><?php echo $val;?></option>
            <?php endforeach;?>
        </select>
        <label class="col-sm-1  control-label no-padding-right" for="form-field-1"> 攻击选手 </label>
        <select disabled>
          <?php if(empty($v['attack_members'])):?>
          <option value=''>请选择</option>
          <?php else: ?>
          <option value="{$list_user_array[$v['attack_members']]}" >{$list_user_array[$v['attack_members']]}</option>
          <?php endif;?>
        </select>
        <label class="col-sm-1  control-label no-padding-right" for="form-field-1"> 防御选手 </label>
        <select disabled>
            <?php if(empty($v['attack_members'])):?>
            <option value=''>请选择</option>
            <?php else: ?>
            <option value='<?php echo $list_user_array[$v["defense_members"]];?>'><?php echo $list_user_array[$v["defense_members"]];?></option>
            <?php endif;?>
        </select>
        <button type="button" onclick="del({$v['id']})">删除</button>
    </div>
</foreach>

<div class="line">
    <form action="" method="post">
    <label class="col-sm-1  control-label no-padding-right" for="form-field-1"> 对抗靶场 </label>
    <select name="target" id='target' required >
      <option value=''>请选择</option>
      <?php foreach($competition as $val):?>
      <option value="<?php echo $val['resistcomp_id'];?>"><?php echo $val['question']?></option>
      <?php endforeach;?>
    </select>
    <label class="col-sm-1  control-label no-padding-right" for="form-field-1"> 团队 </label>
    <select name="team" id='team'  required>
      <option value=''>请选择</option>

      <?php foreach($list_team_array as $key=>$val):?>
      <option value="<?php echo $key;?>"  ><?php echo $val;?></option>
      <?php endforeach;?>
    </select>
    <label class="col-sm-1  control-label no-padding-right" for="form-field-1"> 攻击选手 </label>
    <select name="attack_members" id='attack_members' >
      <option value=''>请选择</option>
    </select>
    <label class="col-sm-1  control-label no-padding-right" for="form-field-1"> 防御选手 </label>
    <select name="affense_members" id='affense_members' >
          <option value=''>请选择</option>
    </select>
    <button type="button" onclick="add()">添加</button>
    </form>
</div>
    <div class="tijiawanigahnegg"  style="margin-top:50px;margin-left:500px;">
        <a href="{:U('Fightcompaign/done',array('id'=>$compid))}"><h2>完成</h2></a>
    </div>
</div>

<!-- 关键词弹出层 -->
<div id="wait" style="display:none;border:1px solid #ccc;height:36px;width:400px;margin:0 auto;z-index:1002;">
    <img src="__PUBLIC__/admin/images/wait.gif" />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#fff;font-size:14px;">该过程需要操作虚拟机，请您稍等...</span>
</div>
<!-- 关键词弹出层 end-->
<script type="text/javascript">
$(document).ready(function(){
    var opitem = $("<option value=''>请选择</option>");
    $("#team").change(function(){
        var url= "{:U('Group/ajax_get_user_list')}" ;
        var teamid = $(this).val();
        var tmp = [];
        tmp.push(opitem);
        $.post(url,{team_id:teamid},function(data){
            if(data.status != 0){
                $.each(data.data,function(idx,obj){
                    tmpitem = opitem.clone();
                    tmpitem.text(obj.user_name).attr("value",obj.user_id);
                    tmp.push(tmpitem);
                });
                $("#affense_members ,#attack_members").empty().append(tmp);
            }
        })
    });

});

function add(){
    var compid = "{$compid}";
    var url = "{:U('fightcompaign/editcompitionteam')}";
    var target = $("#target").val();
    var team = $("#team").val();
    var attack_members = $("#attack_members").val();
    var affense_members = $("#affense_members").val();
    if(target== '' || attack_members== '' ||attack_members=='' || team==''){
        alert("请完善队伍信息");
        return false;
    }
    showmark();
    $("#wait").show();
    $.ajax({
        url:url,
        data:{compid:compid,affense_members:affense_members,attack_members:attack_members,team:team,target:target},
        success:function(data){
            winclose();
            if(data.status === 1){
                alert("ok");
                window.location.href="{:U('fightcompaign/addcompitionteam',array('id'=>$compid))}";
            }else{
                alert("add failed");
            }
        },
        error:function(data){
            winclose();
            alert("执行时间过长，请稍后查看 ");
            window.location.href="{:U('fightcompaign/addcompitionteam',array('id'=>$compid))}";
        }
    });
}
function del(compid){
    var tmp = window.confirm("确定要删除吗");
    if(tmp === false) return false;
    var url = "{:U('fightcompaign/delcompitionteam')}";
    if(compid== ''){
        alert("请完善队伍信息");
        return false;
    }
    showmark();
    $("#wait").show();
    $.ajax({
        url:url,
        data:{id:compid},
        success:function(data){
        winclose();
        if(data.status === 1){
            alert("ok");
            window.location.href="{:U('fightcompaign/addcompitionteam',array('id'=>$compid))}";
        }else{
            alert("del failed");
        }
        },
        error:function(data){
            alert("正在删除中，请稍后查看");
            window.location.href="{:U('fightcompaign/addcompitionteam',array('id'=>$compid))}";
        }
    });
}
    //显示遮罩层
function showmark() {
        var bw = $(document.body).width();
        var bh = $(document.body).height();
        var e = $('<div></div>');
        e.css('background', '#000');
        e.css('width', bw + 'px');
        e.css('height', bh + 'px');
        e.css('position', 'absolute');
        e.css('left', '0');
        e.css('top', '0');
        e.css('-khtml-opacity', '0.5');
        e.css('-moz-opacity', '0.5');
        e.css('opacity', '0.5');
        e.css('filter', 'alpha(opacity=50)');
        e.css('zIndex', '1001');
        e.attr('id', 'masker');
        $(document.body).append(e);
}
    //关闭遮罩层
function winclose() {
        $("#wait").hide();
        $('#masker').remove();
}
</script>
