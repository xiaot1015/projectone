<script type="text/javascript" charset="utf-8" src="__PUBLIC__/uediter/ueditor.config.js"></script>
<script type="text/javascript" charset="utf-8" src="__PUBLIC__/uediter/ueditor.all.min.js"></script>
<!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
<!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
<script type="text/javascript" charset="utf-8" src="__PUBLIC__/uediter/lang/zh-cn/zh-cn.js"></script>
<script src="__PUBLIC__/ace/assets/js/jquery-1.10.2.min.js"></script>
<style type="text/css">
    .xiadanewedweg span:hover{
        cursor:pointer;
    }
</style>
  <script type="text/javascript">
    try {
      ace.settings.check('breadcrumbs', 'fixed')
    } catch (e) {
    }
    var ue = UE.getEditor('desc',{
                toolbars: [
                    ['fullscreen', 'source', 'undo', 'redo', 'bold','italic','selectall','removeformat','unlink','cleardoc','fontfamily','fontsize','forecolor',]
                ],
                autoHeightEnabled: false,
                autoFloatEnabled: true
            });
    var ue_back = UE.getEditor('background',{
                toolbars: [
                    ['fullscreen', 'source', 'undo', 'redo', 'bold','italic','selectall','removeformat','unlink','cleardoc','fontfamily','fontsize','forecolor',]
                ],
                autoHeightEnabled: false,
                autoFloatEnabled: true
            });
  </script>
<form name="form" action="" method="post" onsubmit="return sub()">
    <div style="width:900px;height:450px;overflow: scroll;  overflow-y:auto;  overflow-x:hidden;  position: relative;">
        <div class="xiadanewedweg">
            <p class="yhxxwemzia_b">题库类型：</p>
            <input name="name" type="text" class="yonghuminwgdengl" value="靶场题" disabled/>
            <div class="clear"></div>
        </div>
        <div class="xiadanewedweg">
            <p class="yhxxwemzia_b">对抗靶场：</p>
            <input name="target" type="text" class="yonghuminwgdengl" id="target" value="{$info['question']}" />
            <div class="clear"></div>
        </div>
        <div class="xiadanewedweg">
            <p class="yhxxwemzia_b">子类：</p>
            <select name="typeid" id="typeid" class="xialailewge">
            <option value="">--请选择--</option>
                <foreach name="resistbank" item="val" key="k">
              <if condition="$info['bank_type_id'] eq $k ">
                <option value="{$k}" selected>{$val}</option>
                <else/>
                <option value="{$k}">{$val}</option>
                </if>
                </foreach>
            </select>
            <div class="clear"></div>
        </div>
        <div class="xiadanewedweg" style="color:#fff;">
          <p class="yhxxwemzia_b">靶机: </p>
          <foreach name="vmlist" item="vm">
              <if condition="in_array($vm,$infovms)">
          {$vm}<input type="checkbox" name="target" value="{$vm}" checked />
              <else />
          {$vm}<input type="checkbox" name="target" value="{$vm}" >
              </if >
          </foreach>
        </div>
        <if condition="!empty($list)">
        <hr/>
        <div id="tabarea">
        <table border=1 style="margin-left:20%;width:52%;">
          <tr align="center">
            <td width="16%">关卡序号</td>
            <td>关卡名称</td>
            <td width="14%">分数</td>
            <td width="14%">操作</td>
          </tr>
          <foreach name="list" item="vl" key="k">
           <tr align="center">
            <td>{$k+1}</td>
            <td><a target="_bank" href="../ResistExamination/editgate?deid={$vl.de_id}&id={$info['resistcomp_id']}">{$vl.gatename}</a></td>
            <td>{$vl.score}</td>
            <td><a href="javascript:void(0);" onclick="del({$vl.de_id})">删除</a></td>
          </tr>
          </foreach>
        </table>
        </div>
        <hr/>
        </if>
        <div class="xiadanewedweg">
            <p class="yhxxwemzia_b">说明：</p>
            <div >
            <script id="desc" type="text/plain" style="margin-left:200px;">
            </script>
            </div>
        </div>
        <div class="xiadanewedweg">
          <p class="yhxxwemzia_b">背景：</p>
          <div>
          <script id="background"  type="text/plain" style="margin-left:200px;">
          </script>
          </div>
        </div>
           <div class="xiadanewedweg">
              <p class="yhxxwemzia_b">题目：</p>
              <input name="question" type="text" id="question" class="yonghuminwgdengl"/>
              <div class="clear"></div>
          </div>   
          <div class="xiadanewedweg">
              <p class="yhxxwemzia_b">分数：</p>
              <input name="score" type="text" id="score1" class="yonghuminwgdengl" />
              <div class="clear"></div>
          </div>  
          <div class="xiadanewedweg">
              <p class="yhxxwemzia_b">答案:</p>
              <div class="clear"></div>
          </div>  
          <div id="questionarea">
              <div class="xiadanewedweg" id="item">
                  <p class="yhxxwemzia_b">KEY</p>
                  <input  name="item1" type="text" class="yonghuminwgdengl" />
                  <span name="op" data-id="1" style="margin-left:20px;color:#00aeff;font-size:16px;">删除</span>
                  <span name="op" data-id="2" style="margin-left:20px;color:#00aeff;font-size:16px;">新增</span>
                  <div class="clear"></div>
              </div> 

          </div>
      </div>       
      <input type="hidden" id="id"  name="id" value="{$info['resistcomp_id']}"/>
      <input type="hidden" id="type" name="type" value="{$type}"/>
      <input type="hidden" id="ans" name="ans" value=""/>
      <input type="hidden" id="targetids" name="targetids" value=""/>

      <div class="tijiawanigahnegg" style="margin-left:450px;margin-top:20px;">
	  <a href="javascript:sub(1)">保存并继续下一关</a>
	  <a href="javascript:sub(2)">确定</a>
	  <a href="javascript:sub(4)">取消</a>
	  <a href="javascript:sub(3)">保存并继续下一题</a>

      </div>
      <div class="clear"></div>
</form>
<script type="text/javascript">
$(document).ready(function(){
	$("span[name='op']").bind("click",function(){
		var obj = $(this);
		var typeid = obj.attr("data-id");
		var len = $("#questionarea > div").length;

		var nextlen = parseInt(len) + 1;
		if(typeid == 1){
		    if(len < 1){
			    alert("最多添加6个选项，最少添加1个选项。");
		    	return false;
		    }
			$("#questionarea > div").last().remove();
		}else{
		    if(len >= 6){
			    alert("最多添加6个选项，最少添加1个选项。");
		    	return false;
		    }
			$("#questionarea > div").last().clone(true).appendTo($("#questionarea"));
		    $("#questionarea > div").last().find("p").html("KEY").parent().find("input").first().attr("name","item"+nextlen).val("");
		}
		
	});
});
function del(deid){
	var url = "../ResistExamination/del";
	//var tmp = window.doconfirm("确定执行该操作吗");
	//if(tmp === true){
		$.post(url,{deid:deid},function(data){
			if(data.status == "1"){
				alert(data.info);
				window.location.reload();
			}else{
				alert(data.info);
			}
		});
	//}
	//return false;
}
function sub(savetype){
  if(savetype == 4){
    window.location.href="{:U('ResistExamination/getlist')}";
    return false;
  }
  var ue = UE.getEditor('desc');
  if(!ue.hasContents()){
      alert("说明不能为空");
      return false;
   }else{
      var desc = ue.getContent();
   }
  var ue_back = UE.getEditor('background');
  if(!ue_back.hasContents()){
      alert("背景不能为空");
      return false;
   }else{
      var background = ue_back.getContent();
   }
	var ans = '';
	$("input[name*='item']").each(function(){
		ans +=$(this).val() + "@@"; 
	});
	$("#ans").val(ans);
	var targetids = '';
	$("input[name='target']:checked").each(function(){
		targetids +=$(this).val()+",";
	});
	$("#targetids").val(targetids);
	//var desc = $("#desc").val();
	if(targetids == ''){
      return alert('请选择靶机');
  }
	//var background = $("#background").val();
	var question = $.trim($("#question").val());
    //if(question == "") return alert("关卡题目不能为空");
	var score = $.trim($("#score1").val());
    if(parseInt(score) != score) return alert("分数必须为整数");
	var id = $("#id").val();
	var type = $("#type").val();
	var typeid = $("#typeid").val();
  if(typeid == ''){
      return alert("请选择子类");
  }
	var target = $.trim($("#target").val());
    if(target == "") return alert("对抗靶场不能为空");

	var url = "../ResistExamination/edit";
	$.post(url,{target:target,targetids:targetids,savetype:savetype,ans:ans,desc:desc,background:background,question:question,score:score,type:type,id:id,typeid:typeid},function(data){
		if(data.status == "1"){
			alert(data.info);
			window.location.href=data.data;
		}else{
			alert(data.info);
		}
	});
}
</script>
